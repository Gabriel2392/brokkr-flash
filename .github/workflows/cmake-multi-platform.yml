name: Self-contained bundles

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  # ═══════════════════════════════════════════════════
  #  Linux – Ubuntu 24.04, AppImage
  # ═══════════════════════════════════════════════════
  linux_appimage:
    name: Linux AppImage x64
    runs-on: ubuntu-24.04

    env:
      QT_VERSION: "6.7.3"

    steps:
      - uses: actions/checkout@v4

      - name: Install build deps
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            gcc-14 g++-14 ninja-build cmake patchelf \
            libgl1-mesa-dev libfuse2 imagemagick wget file

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          cache: true
          arch: linux_gcc_64

      - name: Configure
        run: |
          set -euo pipefail
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER=gcc-14 \
            -DCMAKE_CXX_COMPILER=g++-14 \
            -DCMAKE_PREFIX_PATH="$QT_ROOT_DIR"

      - name: Build
        run: cmake --build build --parallel 2

      - name: Stage AppDir
        run: |
          set -euo pipefail
          rm -rf AppDir
          cmake --install build --prefix "$PWD/AppDir/usr"

          mkdir -p AppDir/usr/lib
          cp "$(g++-14 -print-file-name=libstdc++.so.6)" AppDir/usr/lib/ || true
          cp "$(gcc-14 -print-file-name=libgcc_s.so.1)"  AppDir/usr/lib/ || true

      - name: Desktop file + icon
        run: |
          set -euo pipefail
          mkdir -p AppDir/usr/share/applications \
                   AppDir/usr/share/icons/hicolor/256x256/apps

          # Desktop file – no leading whitespace
          cat > AppDir/usr/share/applications/brokkr.desktop << 'DESKTOP'
          [Desktop Entry]
          Type=Application
          Name=Brokkr
          Exec=brokkr
          Icon=brokkr
          Categories=Utility;
          Terminal=false
          DESKTOP
          sed -i 's/^[[:space:]]*//' AppDir/usr/share/applications/brokkr.desktop

          # Extract largest frame from ICO, then force-resize to exactly 256x256
          convert assets/brokkr.ico /tmp/brokkr_frame.png
          biggest="$(ls -rS /tmp/brokkr_frame*.png | tail -n1)"
          convert "$biggest" -resize 256x256! \
            AppDir/usr/share/icons/hicolor/256x256/apps/brokkr.png

          # Verify
          identify AppDir/usr/share/icons/hicolor/256x256/apps/brokkr.png

      - name: Build AppImage
        run: |
          set -euo pipefail
          wget -q "https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage"
          wget -q "https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage"
          chmod +x linuxdeploy-x86_64.AppImage linuxdeploy-plugin-qt-x86_64.AppImage

          export PATH="$QT_ROOT_DIR/bin:$PATH"
          export QMAKE="$QT_ROOT_DIR/bin/qmake"

          ./linuxdeploy-x86_64.AppImage \
            --appdir AppDir \
            -e AppDir/usr/bin/brokkr \
            -d AppDir/usr/share/applications/brokkr.desktop \
            -i AppDir/usr/share/icons/hicolor/256x256/apps/brokkr.png \
            --plugin qt \
            --output appimage

          mv Brokkr-x86_64.AppImage Brokkr-linux-x86_64.AppImage

      - uses: actions/upload-artifact@v4
        with:
          name: Brokkr-linux-x86_64.AppImage
          path: Brokkr-linux-x86_64.AppImage

  # ═══════════════════════════════════════════════════
  #  Windows x64  (NSIS installer)
  #
  #  Qt 6.7.x archives use "msvc2019" naming even
  #  though they work fine with VS 2022 toolchain.
  # ═══════════════════════════════════════════════════
  windows_installer:
    name: Windows installer x64
    runs-on: windows-2022

    env:
      QT_VERSION: "6.7.3"

    steps:
      - uses: actions/checkout@v4

      - uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install NSIS + Ninja
        shell: powershell
        run: choco install nsis ninja -y

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          cache: true
          arch: win64_msvc2019_64

      - name: Configure
        shell: bash
        run: |
          set -euo pipefail
          echo "$QT_ROOT_DIR/bin" >> "$GITHUB_PATH"
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            "-DCMAKE_PREFIX_PATH=$QT_ROOT_DIR"

      - name: Build
        shell: bash
        run: cmake --build build --parallel 2

      - name: Package (NSIS installer)
        shell: bash
        run: |
          set -euo pipefail
          cd build
          cpack -G NSIS -C Release || {
            echo "::error::NSIS packaging failed – dumping log:"
            cat _CPack_Packages/*/NSIS/NSISOutput.log 2>/dev/null || true
            exit 1
          }
          installer="$(ls -1 *.exe | head -n1)"
          mv "$installer" ../Brokkr-windows-x64.exe

      - name: Package (portable zip)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p portable/brokkr
          cp build/brokkr.exe portable/brokkr/
          "$QT_ROOT_DIR/bin/windeployqt.exe" portable/brokkr/brokkr.exe
          cd portable
          7z a -tzip ../Brokkr-windows-x64.zip brokkr/

      - uses: actions/upload-artifact@v4
        with:
          name: Brokkr-windows-x64.exe
          path: Brokkr-windows-x64.exe

      - uses: actions/upload-artifact@v4
        with:
          name: Brokkr-windows-x64.zip
          path: Brokkr-windows-x64.zip

  # ═══════════════════════════════════════════════════
  #  macOS arm64 only
  # ═══════════════════════════════════════════════════
  macos_app:
    name: macOS app arm64
    runs-on: macos-15

    env:
      QT_VERSION: "6.7.3"

    steps:
      - uses: actions/checkout@v4

      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install Ninja
        run: brew install ninja

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          cache: true
          arch: clang_64

      - name: Configure
        run: |
          set -euo pipefail
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH="$QT_ROOT_DIR" \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=13.0

      # ── THE FIX ─────────────────────────────────────
      # Qt 6.7 injects -framework AGL during generation.
      # macOS 14+/15+ SDK removed AGL.framework.
      # Strip it from the generated build file directly.
      # ────────────────────────────────────────────────
      - name: Strip missing AGL framework from build files
        run: |
          set -euo pipefail
          echo "Before:"
          grep -c 'framework AGL' build/build.ninja || echo "(none)"
          sed -i '' 's/ -framework AGL//g; s/-framework AGL //g; s/-framework AGL//g' build/build.ninja
          echo "After:"
          grep -c 'framework AGL' build/build.ninja && exit 1 || echo "✓ All AGL references removed"

      - name: Build
        run: cmake --build build --parallel 3

      - name: Deploy + zip
        run: |
          set -euo pipefail
          APP="build/brokkr.app"
          "$QT_ROOT_DIR/bin/macdeployqt" "$APP" -verbose=2
          ditto -c -k --sequesterRsrc --keepParent "$APP" Brokkr-macos-arm64.app.zip

      - uses: actions/upload-artifact@v4
        with:
          name: Brokkr-macos-arm64.app.zip
          path: Brokkr-macos-arm64.app.zip
