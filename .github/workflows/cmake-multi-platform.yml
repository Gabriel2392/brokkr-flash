name: CMake on multiple platforms

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            build_type: Release
            c_compiler: clang
            cpp_compiler: clang++

          - os: macos-latest
            build_type: Release
            c_compiler: clang
            cpp_compiler: clang++

          - os: windows-latest
            build_type: Release
            c_compiler: cl
            cpp_compiler: cl

    steps:
      - uses: actions/checkout@v4

      - name: Set build dir
        id: strings
        shell: bash
        run: echo "build-output-dir=${{ github.workspace }}/build" >> "$GITHUB_OUTPUT"

      # ---- Qt6: install via aqtinstall for GUI target ----
      - name: Install Qt6 dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-dev

      - name: Install Qt6
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.3'
          cache: true

      # ---- macOS: install brew LLVM so we do NOT use AppleClang ----
      - name: Install LLVM (macOS)
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          set -euo pipefail
          brew update
          brew install llvm

      - name: Configure (Linux/macOS)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          set -euo pipefail

          extra_args=(
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
            -DCMAKE_CXX_STANDARD=23
            -DCMAKE_CXX_STANDARD_REQUIRED=ON
            -DCMAKE_CXX_EXTENSIONS=OFF
            -DCMAKE_PREFIX_PATH="$QT_ROOT_DIR"
          )

          if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
            extra_args+=(
              -DCMAKE_C_COMPILER=${{ matrix.c_compiler }}
              -DCMAKE_CXX_COMPILER=${{ matrix.cpp_compiler }}
              -DCMAKE_EXE_LINKER_FLAGS_RELEASE=-s
              -DCMAKE_SHARED_LINKER_FLAGS_RELEASE=-s
              -DCMAKE_MODULE_LINKER_FLAGS_RELEASE=-s
            )
          fi

          if [[ "${{ matrix.os }}" == "macos-latest" ]]; then
            LLVM_PREFIX="$(brew --prefix llvm)"

            # Use brew clang/clang++ (not AppleClang)
            extra_args+=(
              -DCMAKE_C_COMPILER="$LLVM_PREFIX/bin/clang"
              -DCMAKE_CXX_COMPILER="$LLVM_PREFIX/bin/clang++"
              -DCMAKE_OSX_DEPLOYMENT_TARGET=11.0
            )

            # CRITICAL: ensure we link against brew libc++/libc++abi (matches brew headers)
            # Also avoid "-s" on macOS ld (obsolete); we strip after build.
            extra_args+=(
              -DCMAKE_EXE_LINKER_FLAGS="-L$LLVM_PREFIX/lib -L$LLVM_PREFIX/lib/c++ -Wl,-rpath,$LLVM_PREFIX/lib -Wl,-rpath,$LLVM_PREFIX/lib/c++"
              -DCMAKE_SHARED_LINKER_FLAGS="-L$LLVM_PREFIX/lib -L$LLVM_PREFIX/lib/c++ -Wl,-rpath,$LLVM_PREFIX/lib -Wl,-rpath,$LLVM_PREFIX/lib/c++"
              -DCMAKE_MODULE_LINKER_FLAGS="-L$LLVM_PREFIX/lib -L$LLVM_PREFIX/lib/c++ -Wl,-rpath,$LLVM_PREFIX/lib -Wl,-rpath,$LLVM_PREFIX/lib/c++"
            )
          fi

          cmake -B "${{ steps.strings.outputs.build-output-dir }}" \
                -S "${{ github.workspace }}" \
                "${extra_args[@]}"

      - name: Configure (Windows)
        if: matrix.os == 'windows-latest'
        shell: bash
        run: |
          set -euo pipefail
          cmake -B "${{ steps.strings.outputs.build-output-dir }}" \
                -S "${{ github.workspace }}" \
                -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
                -DCMAKE_C_COMPILER=${{ matrix.c_compiler }} \
                -DCMAKE_CXX_COMPILER=${{ matrix.cpp_compiler }} \
                -DCMAKE_CXX_STANDARD=23 \
                -DCMAKE_CXX_STANDARD_REQUIRED=ON \
                -DCMAKE_CXX_EXTENSIONS=OFF \
                -DCMAKE_PREFIX_PATH="$QT_ROOT_DIR" \
                -DCPACK_GENERATOR="ZIP;TGZ" \
                -DCMAKE_MSVC_DEBUG_INFORMATION_FORMAT="" \
                -DCMAKE_EXE_LINKER_FLAGS_RELEASE="/INCREMENTAL:NO /DEBUG:NONE"

      - name: Build
        shell: bash
        run: |
          set -euo pipefail
          cmake --build "${{ steps.strings.outputs.build-output-dir }}" \
                --config ${{ matrix.build_type }} \
                --parallel 2

      - name: Strip (Linux/macOS, best-effort)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ steps.strings.outputs.build-output-dir }}"

          while IFS= read -r -d '' f; do
            file "$f" | grep -E "ELF|Mach-O" >/dev/null || continue
            # macOS: -x strips local symbols; safe for release
            if [[ "${{ matrix.os }}" == "macos-latest" ]]; then
              strip -x "$f" || true
            else
              strip "$f" || true
            fi
          done < <(find . -type f -perm -111 -print0)

      - name: Test
        shell: bash
        working-directory: ${{ steps.strings.outputs.build-output-dir }}
        run: ctest --build-config ${{ matrix.build_type }} --parallel 2

      # ---- PACKAGING ----
      - name: CPack (Linux/macOS)
        if: matrix.os != 'windows-latest'
        shell: bash
        working-directory: ${{ steps.strings.outputs.build-output-dir }}
        run: cpack

      - name: CPack (Windows ZIP only)
        if: matrix.os == 'windows-latest'
        shell: bash
        working-directory: ${{ steps.strings.outputs.build-output-dir }}
        run: cpack -G ZIP

      - name: CPack (Windows TGZ only)
        if: matrix.os == 'windows-latest'
        shell: bash
        working-directory: ${{ steps.strings.outputs.build-output-dir }}
        run: cpack -G TGZ

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-${{ matrix.build_type }}
          path: |
            ${{ steps.strings.outputs.build-output-dir }}/Brokkr-*.*
            ${{ steps.strings.outputs.build-output-dir }}/**/brokkr*
            ${{ steps.strings.outputs.build-output-dir }}/**/Brokkr*
            ${{ steps.strings.outputs.build-output-dir }}/*.exe
